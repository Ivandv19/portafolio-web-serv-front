---
import { useTranslations } from '../i18n/utils';

interface Props {
  lang?: 'es' | 'en';
}

const { lang = 'es' } = Astro.props;
const t = useTranslations(lang);
---

<section id="contacto" class="py-24 px-4 lg:px-20 bg-base-100">
  <div class="max-w-6xl mx-auto">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
      <div class="lg:sticky lg:top-32">
        <h2 class="text-5xl font-black mb-6">
          <span set:html={t('contact.title')} />
        </h2>
        <p class="text-lg opacity-70 mb-8">
          {t('contact.desc')}
        </p>

        <div class="lg:col-span-1 space-y-4">
          <div class="relative group">
            <a
              href="mailto:ivangtx19@gmail.com"
              class="card bg-base-200 border border-white/5 shadow-xl p-6 flex-row items-center gap-4 hover:border-primary/30 transition-all active:scale-95"
            >
              <div class="bg-primary/10 text-primary p-3 rounded-xl">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><rect width="20" height="16" x="2" y="4" rx="2"></rect><path
                    d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg
                >
              </div>
              <div class="flex-1">
                <h4
                  class="font-bold text-sm uppercase tracking-widest opacity-60"
                >
                  {t('contact.email')}
                </h4>
                <p class="text-sm font-semibold">ivangtx19@gmail.com</p>
              </div>
            </a>
            <button
              onclick="navigator.clipboard.writeText('ivangtx19@gmail.com')"
              class="btn btn-ghost btn-xs absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity"
              title="Copiar correo">{t('contact.copy')}</button
            >
          </div>

          <div class="relative group">
            <a
              href="https://wa.me/525667723938"
              target="_blank"
              class="card bg-base-200 border border-white/5 shadow-xl p-6 flex-row items-center gap-4 hover:border-secondary/30 transition-all active:scale-95"
            >
              <div class="bg-secondary/10 text-secondary p-3 rounded-xl">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"
                  ></path></svg
                >
              </div>
              <div class="flex-1">
                <h4
                  class="font-bold text-sm uppercase tracking-widest opacity-60"
                >
                  {t('contact.whatsapp')}
                </h4>
                <p class="text-sm font-semibold">+52 56 6772 3938</p>
              </div>
            </a>
            <button
              onclick="navigator.clipboard.writeText('525667723938')"
              class="btn btn-ghost btn-xs absolute right-4 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity"
              title="Copiar número">{t('contact.copy')}</button
            >
          </div>

          <div class="relative group">
            <a
              href="https://www.google.com/maps/place/México/@23.634501,-102.552784,5z/"
              target="_blank"
              class="card bg-base-200 border border-white/5 shadow-xl p-6 flex-row items-center gap-4 hover:border-accent/30 transition-all active:scale-95"
            >
              <div class="bg-accent/10 text-accent p-3 rounded-xl">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="24"
                  height="24"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  ><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"
                  ></path><circle cx="12" cy="10" r="3"></circle></svg
                >
              </div>
              <div class="flex-1">
                <h4
                  class="font-bold text-sm uppercase tracking-widest opacity-60"
                >
                  {t('contact.location')}
                </h4>
                <p class="text-sm font-semibold">México</p>
              </div>
            </a>
          </div>
        </div>
      </div>

      <div class="card bg-base-200 shadow-xl border border-white/5">
        <form 
          id="contactForm" 
          class="card-body p-8 flex flex-col gap-y-5"
          data-msg-sending={t('contact.form.sending')}
          data-msg-success={t('contact.form.success')}
          data-msg-error={t('contact.form.error')}
        >
          
          <input
            type="text"
            name="fax_number"
            style="display:none !important"
            tabindex="-1"
            autocomplete="off"
          />

          <div class="form-control w-full">
            <label for="nombre" class="label pb-1">
              <span class="label-text font-semibold">{t('contact.form.name')}</span>
            </label>
            <input
              id="nombre"
              name="nombre"
              type="text"
              placeholder="Ej. Ivan Cruz"
              class="input input-bordered w-full focus:input-primary transition-all"
              required
            />
          </div>

          <div class="form-control w-full">
            <label for="email" class="label pb-1">
              <span class="label-text font-semibold">{t('contact.form.email')}</span>
            </label>
            <input
              id="email"
              name="email"
              type="email"
              placeholder="tu@email.com"
              class="input input-bordered w-full focus:input-primary transition-all"
              required
            />
          </div>

          <div class="form-control w-full">
            <label for="servicio" class="label pb-1">
              <span class="label-text font-semibold"
                >{t('contact.form.service')}</span
              >
            </label>
            <select
              id="servicio"
              name="servicio"
              class="select select-bordered w-full focus:select-primary transition-all"
            >
              <option disabled selected>{t('contact.form.service.option.default')}</option>
              <option>{t('contact.form.service.option.frontend')}</option>
              <option>{t('contact.form.service.option.hosting')}</option>
              <option>{t('contact.form.service.option.pack')}</option>
            </select>
          </div>

          <div class="form-control w-full">
            <label for="mensaje" class="label pb-1">
              <span class="label-text font-semibold">{t('contact.form.message')}</span>
            </label>
            <textarea
              id="mensaje"
              name="mensaje"
              class="textarea textarea-bordered h-32 w-full focus:textarea-primary transition-all"
              placeholder={t('contact.form.message.placeholder')}
              required></textarea>
          </div>

          <div id="formStatus" class="hidden alert text-sm mt-2"></div>

          <div class="form-control mt-4">
            <button
              type="submit"
              id="submitBtn"
              class="btn btn-primary btn-block text-white"
            >
              {t('contact.form.submit')}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</section>

<script is:inline>
  // Seleccionamos los elementos del DOM
  const form = document.getElementById('contactForm');
  const statusDiv = document.getElementById('formStatus');
  const submitBtn = document.getElementById('submitBtn');

  // Obtener mensajes traducidos
  const msgSending = form.dataset.msgSending;
  const msgSuccess = form.dataset.msgSuccess;
  const msgError = form.dataset.msgError;

  // Escuchamos el evento cuando envían el form
  form.addEventListener('submit', async function (e) {
    e.preventDefault(); // Evita que la página se recargue

    // 1. UI: Cambiar botón a estado "Cargando"
    const originalBtnText = submitBtn.innerText;
    submitBtn.innerText = msgSending;
    submitBtn.disabled = true;
    statusDiv.classList.add('hidden'); // Ocultar mensajes previos

    // 2. Capturar datos de los inputs con 'name'
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      // 3. Enviar a tu backend de Cloudflare
      const response = await fetch('/api/send-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data),
      });

      const result = await response.json();

      if (response.ok) {
        // ÉXITO: Mostrar mensaje verde y limpiar form
        statusDiv.innerText = msgSuccess;
        statusDiv.className = 'alert alert-success mt-2 text-white shadow-lg';
        statusDiv.classList.remove('hidden');
        form.reset();
      } else {
        // ERROR: Mostrar mensaje rojo
        throw new Error(result.error || msgError);
      }
    } catch (error) {
      console.error(error);
      statusDiv.innerText = msgError;
      statusDiv.className = 'alert alert-error mt-2 text-white shadow-lg';
      statusDiv.classList.remove('hidden');
    } finally {
      // 4. Restaurar botón (siempre se ejecuta)
      submitBtn.innerText = originalBtnText;
      submitBtn.disabled = false;

      // Opcional: Ocultar el mensaje de éxito después de 5 segundos
      if (statusDiv.classList.contains('alert-success')) {
        setTimeout(() => {
          statusDiv.classList.add('hidden');
        }, 5000);
      }
    }
  });
</script>
