---
import "../styles/global.css";
// Supports weights 100-900
import '@fontsource/outfit';

import { useTranslations } from "../i18n/utils";
import { ClientRouter } from "astro:transitions";
import ThemeToggle from "../components/ThemeToggle.astro";
import LanguagePicker from "../components/LanguagePicker.astro";
import Footer from "../components/Footer.astro";

interface Props {
  title: string;
  lang?: "es" | "en";
}

const { title, lang = "es" } = Astro.props;
const t = useTranslations(lang);
---

<!doctype html>
<html lang={lang} class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={t('meta.description')} />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title}</title>
    <ClientRouter />

    <!-- Theme Persistence Script (Avoids Flash of Wrong Theme) -->
    <script is:inline>
        (function() {
            const savedTheme = localStorage.getItem("theme");
            const systemTheme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "business" : "nord";
            const theme = savedTheme || systemTheme;
            
            document.documentElement.setAttribute("data-theme", theme);
            if (theme === 'business') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();
    </script>
    
    <!-- Google Analytics (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9YLWS6TY5V"></script>
    <script is:inline>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-9YLWS6TY5V');
    </script>

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json" is:inline set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Ivan Cruz",
      "url": "https://web-portfolio-f.mgdc.site",
      "image": "https://web-portfolio-f.mgdc.site/favicon.svg",
      "sameAs": [
        "https://github.com/Ivandv19"
      ],
      "jobTitle": t('footer.role'),
      "description": t('meta.description'),
      "knowsAbout": [
        "Frontend Development",
        "React",
        "Astro",
        "Cloud Hosting",
        "Infrastructure"
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": t('services.title'),
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": t('services.landing.title'),
              "description": t('services.landing.desc')
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": t('services.infra.title'),
              "description": t('services.infra.desc')
            }
          }
        ]
      }
    })}>
    </script>
  </head>
  <body class="flex flex-col min-h-screen bg-base-100 text-base-content antialiased transition-colors duration-400">
    
    <header class="navbar bg-base-100/80 text-base-content backdrop-blur-md border-b border-base-content/10 sticky top-0 z-50 px-4 lg:px-8 xl:px-20">
      <div class="navbar-start">
        <div class="dropdown">
          <label tabindex="0" class="btn btn-ghost xl:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h8m-8 6h16" />
            </svg>
          </label>
          <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-1 p-2 shadow bg-base-200 rounded-box w-52 font-medium">
            <li><a href="#hero">{t('nav.home')}</a></li>
            <li><a href="#servicios">{t('nav.services')}</a></li>
            <li><a href="#proyectos">{t('nav.projects')}</a></li>
            <li><a href="#testimonios">{t('nav.testimonials')}</a></li>
            <li><a href="#sobre-mi">{t('nav.about')}</a></li>
            <div class="divider my-1 opacity-5"></div>
            <li class="p-2">
               <div class="flex items-center justify-between w-full">
                  <span class="text-[10px] font-bold opacity-40 uppercase tracking-widest">{lang === 'es' ? 'Idioma' : 'Language'}</span>
                  <LanguagePicker />
               </div>
            </li>
            <li class="p-2 flex flex-row gap-2 items-center">
                <a href="#contacto" class="btn btn-primary btn-sm text-white grow h-10 min-h-0">{t('nav.contact')}</a>
                <ThemeToggle class="bg-base-300/50" />
            </li>
          </ul>
        </div>

        <a href="#hero" class="text-xl font-bold tracking-tighter">
          {t('nav.logo.text')}<span class="text-primary">{t('nav.logo.highlight')}</span>
        </a>
      </div>

      <div class="navbar-end hidden xl:flex">
        <ul class="menu menu-horizontal px-1 font-medium gap-2 flex-nowrap">
          <li><a href="#hero" class="hover:text-primary transition-colors">{t('nav.home')}</a></li>
          <li><a href="#servicios" class="hover:text-primary transition-colors">{t('nav.services')}</a></li>
          <li><a href="#proyectos" class="hover:text-primary transition-colors">{t('nav.projects')}</a></li>
          <li><a href="#testimonios" class="hover:text-primary transition-colors">{t('nav.testimonials')}</a></li>
          <li><a href="#sobre-mi" class="hover:text-primary transition-colors">{t('nav.about')}</a></li>
        </ul>

        <a href="#contacto" class="btn btn-primary btn-sm ml-4 text-white border-none px-6">
          {t('nav.contact')}
        </a>
        
        <!-- Theme Toggle -->
        <ThemeToggle class="ml-2" />

        <!-- Desktop Language Selector -->
        <LanguagePicker />
      </div>
    </header>

    <main class="grow" transition:animate="fade">
      <slot />
    </main>

  
    <Footer />

    <script>
      const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
      };

      const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, observerOptions);

      document.addEventListener('astro:page-load', () => {
        const hiddenElements = document.querySelectorAll('.animate-on-scroll');
        hiddenElements.forEach((el) => observer.observe(el));
      });
    </script>
  </body>
</html>